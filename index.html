<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Matcher | Auditoria Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        details summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="h-16 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-sky-400 tracking-tight">Formula<span class="text-white">Matcher</span></h1>
            <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-600">
                <input type="text" id="targetId" placeholder="ID Alvo (Ex: 424)" class="bg-transparent px-3 py-1 text-sm outline-none w-32 mono">
                <button onclick="buscar()" class="bg-sky-600 hover:bg-sky-500 px-4 py-1 rounded-md text-sm font-bold transition-all">Analisar</button>
            </div>
        </div>
        <div id="db-info" class="text-xs text-slate-500 mono">Carregando...</div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- SIDEBAR: ALVO -->
        <aside class="w-80 bg-slate-900 border-r border-slate-700 flex flex-col shrink-0">
            <div class="p-4 border-b border-slate-700 text-xs font-bold text-slate-500 uppercase">Fórmula de Referência</div>
            <div id="target-area" class="flex-1 overflow-y-auto p-4 custom-scroll">
                <div class="text-center mt-20 text-slate-600 text-sm">Digite um ID para iniciar.</div>
            </div>
        </aside>

        <!-- CONTEÚDO: FILTROS E RESULTADOS -->
        <section class="flex-1 flex flex-col bg-slate-950">
            <!-- PAINEL DE VETOS -->
            <div id="veto-panel" class="hidden p-4 bg-slate-900/50 border-b border-slate-800">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Vetar Aditivos Extras (Clique para ocultar fórmulas)</span>
                    <button onclick="resetVetos()" class="text-[10px] text-sky-400 hover:underline">Limpar Bloqueios</button>
                </div>
                <div id="veto-chips" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- LISTA -->
            <div id="results-area" class="flex-1 overflow-y-auto p-6 custom-scroll">
                <div id="empty-msg" class="text-center mt-20 text-slate-500">Aguardando análise estrutural...</div>
                <div id="results-list" class="max-w-4xl mx-auto space-y-4"></div>
            </div>
        </section>
    </main>

<script>
    const CSV_URL = 'https://andregazineu.github.io/Formula-Matcher/database_limpo_final.csv';
    let DB = {};
    let CURRENT_RESULTS = [];
    let ACTIVE_VETOS = new Set();

    // 1. Carregamento
    window.onload = () => {
        Papa.parse(CSV_URL, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, delimiter: ";",
            complete: (res) => {
                res.data.forEach(row => {
                    const id = String(row.ID_Composicao);
                    if (!DB[id]) DB[id] = { id, nome: row.Nome_Composicao, vetorBase: {}, vetorCor: {}, aditivosMap: new Map(), itens: [] };
                    
                    const desc = String(row.Descricao_Material).toUpperCase().replace(/"/g, '');
                    const tipo = desc.startsWith('PIG.') ? 'PIG' : (desc.startsWith('ADIT.') ? 'ADIT' : 'BASE');
                    const chave = `${row.Grupo_Rosca}_${row.Cod_Material}`;
                    const qtdF = row.Qtd_Corrigida_No_Filme || 0;

                    if (tipo === 'BASE') DB[id].vetorBase[chave] = (DB[id].vetorBase[chave] || 0) + qtdF;
                    if (tipo === 'PIG') DB[id].vetorCor[chave] = (DB[id].vetorCor[chave] || 0) + qtdF;
                    
                    if (tipo !== 'BASE') {
                        const nomeLimpo = desc.replace(/^(ADIT\.|PIG\.)\s*/, '');
                        DB[id].aditivosMap.set(nomeLimpo, (DB[id].aditivosMap.get(nomeLimpo) || 0) + qtdF);
                    }

                    DB[id].itens.push({ desc, tipo, rosca: row.Grupo_Rosca, perc: row.Percentual_Rosca, qtd: row.Qtd_Original_Na_Rosca || 0 });
                });
                document.getElementById('db-info').textContent = `DB: ${Object.keys(DB).length} fórmulas`;
            }
        });
    };

    // 2. Matemática
    function cosseno(v1, v2) {
        let dot = 0, m1 = 0, m2 = 0;
        const keys = new Set([...Object.keys(v1), ...Object.keys(v2)]);
        keys.forEach(k => {
            const a = v1[k] || 0, b = v2[k] || 0;
            dot += a * b; m1 += a * a; m2 += b * b;
        });
        return (m1 && m2) ? dot / (Math.sqrt(m1) * Math.sqrt(m2)) : (m1 === m2 ? 1 : 0);
    }

    // 3. Busca e Auditoria
    function buscar() {
        const id = document.getElementById('targetId').value.trim();
        if (!DB[id]) return alert("ID não encontrado");
        
        const alvo = DB[id];
        renderAlvo(alvo);
        ACTIVE_VETOS.clear();
        document.getElementById('veto-panel').classList.remove('hidden');
        document.getElementById('empty-msg').classList.add('hidden');

        const alvoCor = Object.keys(alvo.vetorCor).length > 0;
        const lista = [];

        Object.values(DB).forEach(cand => {
            if (cand.id === id) return;
            
            // Filtro de Cor Rígido
            const candCor = Object.keys(cand.vetorCor).length > 0;
            if (alvoCor !== candCor) return;
            if (alvoCor && cosseno(alvo.vetorCor, cand.vetorCor) < 0.9) return;

            // Similaridade de Resina
            const score = cosseno(alvo.vetorBase, cand.vetorBase);
            if (score > 0.4) {
                // Auditoria de Diferenças
                const extras = [], faltas = [];
                cand.aditivosMap.forEach((q, n) => { if (!alvo.aditivosMap.has(n)) extras.push({ n, q }); });
                alvo.aditivosMap.forEach((q, n) => { if (!cand.aditivosMap.has(n)) faltas.push(n); });
                lista.push({ ...cand, score, extras, faltas });
            }
        });

        CURRENT_RESULTS = lista.sort((a, b) => b.score - a.score);
        atualizarUI();
    }

    // 4. UI e Vetos
    function atualizarUI() {
        const vetoContainer = document.getElementById('veto-chips');
        const listContainer = document.getElementById('results-list');
        vetoContainer.innerHTML = '';
        listContainer.innerHTML = '';

        const extrasCount = new Map();
        const visiveis = CURRENT_RESULTS.filter(c => {
            const bloqueado = c.extras.some(e => ACTIVE_VETOS.has(e.n));
            if (!bloqueado) c.extras.forEach(e => extrasCount.set(e.n, (extrasCount.get(e.n) || 0) + 1));
            return !bloqueado;
        });

        // Render Chips
        extrasCount.forEach((count, nome) => {
            const btn = document.createElement('button');
            btn.className = `text-[10px] px-2 py-1 rounded border border-slate-700 bg-slate-800 hover:border-sky-500 transition-all`;
            btn.innerHTML = `Bloquear ${nome} <span class="text-sky-400 ml-1">${count}</span>`;
            btn.onclick = () => { ACTIVE_VETOS.add(nome); atualizarUI(); };
            vetoContainer.appendChild(btn);
        });

        // Render Cards
        visiveis.slice(0, 20).forEach(c => {
            const card = document.createElement('div');
            card.className = "bg-slate-900 border border-slate-800 p-4 rounded-xl hover:border-sky-500/50 transition-all";
            
            let diffHtml = c.extras.map(e => `<span class="text-[10px] bg-amber-500/10 text-amber-500 border border-amber-500/20 px-2 py-0.5 rounded">+ ${e.n} (${e.q.toFixed(1)}%)</span>`).join('');
            diffHtml += c.faltas.map(f => `<span class="text-[10px] bg-red-500/10 text-red-500 border border-red-500/20 px-2 py-0.5 rounded">- Falta: ${f}</span>`).join('');
            if (!diffHtml) diffHtml = `<span class="text-[10px] bg-emerald-500/10 text-emerald-500 px-2 py-0.5 rounded">Aditivação Idêntica</span>`;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-white">${c.nome}</h3>
                        <span class="text-[10px] mono text-slate-500">ID: ${c.id}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-black text-sky-500">${(c.score * 100).toFixed(0)}%</div>
                        <div class="text-[8px] uppercase text-slate-500">Resina</div>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mb-4">${diffHtml}</div>
                <details class="group">
                    <summary class="text-xs text-slate-500 cursor-pointer hover:text-sky-400">Ver Estrutura Detalhada</summary>
                    <div class="mt-3 space-y-2 border-t border-slate-800 pt-3">${renderEstrutura(c.itens)}</div>
                </details>
            `;
            listContainer.appendChild(card);
        });
    }

    function renderAlvo(alvo) {
        document.getElementById('target-area').innerHTML = `
            <div class="mb-4">
                <h2 class="font-bold text-white leading-tight">${alvo.nome}</h2>
                <div class="text-xs mono text-sky-500 mt-1">ID: ${alvo.id}</div>
            </div>
            <div class="space-y-4">${renderEstrutura(alvo.itens)}</div>
        `;
    }

    function renderEstrutura(itens) {
        const grupos = itens.reduce((acc, i) => {
            if (!acc[i.rosca]) acc[i.rosca] = { p: i.perc, h: [] };
            const cor = i.tipo === 'BASE' ? 'text-sky-400' : (i.tipo === 'PIG' ? 'text-purple-400' : 'text-amber-400');
            acc[i.rosca].h.push(`<div class="flex justify-between text-[10px] py-0.5 border-b border-white/5"><span class="truncate ${cor} opacity-80">${i.desc}</span><span class="mono ml-2">${i.qtd.toFixed(1)}%</span></div>`);
            return acc;
        }, {});
        return Object.keys(grupos).sort().map(r => `<div class="mb-2"><div class="flex justify-between text-[9px] font-bold text-slate-500 uppercase mb-1"><span>${r}</span><span>${grupos[r].p}%</span></div>${grupos[r].h.join('')}</div>`).join('');
    }

    function resetVetos() { ACTIVE_VETOS.clear(); atualizarUI(); }
</script>
</body>
</html>
