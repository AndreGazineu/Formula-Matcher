<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Matcher | Interactive Tree</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #111827; --card-bg: #1f2937; --border: #374151;
            --text: #f3f4f6; --text-dim: #9ca3af;
            --primary: #3b82f6; --accent: #8b5cf6;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding-bottom: 50px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Header */
        header { border-bottom: 1px solid var(--border); padding: 20px 0; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--primary); font-size: 1.5rem; }
        
        /* Search Bar */
        .search-container { display: flex; gap: 10px; background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 30px; }
        input, select { background: #000; border: 1px solid var(--border); color: white; padding: 10px 15px; border-radius: 8px; font-family: 'Inter'; }
        button.btn-search { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button.btn-search:hover { filter: brightness(1.1); }

        /* Layout Principal */
        .grid-layout { display: grid; grid-template-columns: 380px 1fr; gap: 30px; align-items: start; }
        
        /* Card Alvo */
        .target-card { position: sticky; top: 20px; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary); border-radius: 12px; padding: 20px; }
        .target-header { border-bottom: 1px solid rgba(59, 130, 246, 0.3); padding-bottom: 10px; margin-bottom: 15px; }
        
        /* Área de Filtros (A "Árvore") */
        .filters-panel { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .filters-title { font-size: 0.9rem; color: var(--text-dim); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .filters-container { display: flex; flex-wrap: wrap; gap: 10px; }
        
        .filter-chip { 
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; border: 1px solid var(--border); 
            background: #111; color: var(--text-dim); transition: 0.2s; user-select: none;
        }
        .filter-chip:hover { border-color: var(--text); color: var(--text); }
        .filter-chip.active { background: var(--success); color: #000; border-color: var(--success); font-weight: 700; }
        .filter-chip.match { border-color: var(--warning); color: var(--warning); } /* Se o alvo já tem */

        /* Lista de Resultados */
        .results-list { display: flex; flex-direction: column; gap: 15px; }
        .result-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: 0.3s; }
        .result-card.hidden { display: none; }
        .result-card:hover { border-color: var(--text-dim); transform: translateY(-2px); }

        /* Score e Badges */
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .similarity-badge { background: #111; padding: 5px 10px; border-radius: 6px; text-align: right; border: 1px solid var(--border); }
        .score-val { color: var(--primary); font-weight: 800; font-size: 1.4rem; }
        .score-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }

        /* Estrutura Visual */
        .structure-preview { margin-top: 15px; font-size: 0.85rem; }
        .layer-row { display: flex; gap: 10px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .layer-name { color: var(--primary); font-weight: bold; min-width: 60px; font-size: 0.75rem; }
        
        .mat-tag { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; display: inline-block; }
        .tag-res { color: #93c5fd; background: rgba(59, 130, 246, 0.15); }
        .tag-fun { color: #fbbf24; background: rgba(245, 158, 11, 0.15); }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .loader-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-out { opacity: 0; pointer-events: none; transition: 0.5s; }
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-spinner"></div>
    <div style="font-family: 'JetBrains Mono'; color: var(--primary);">Carregando Base de Dados...</div>
</div>

<div class="container">
    <header>
        <div class="brand">Formula Matcher <span style="font-size:0.8rem; color:#666;">v5.0 Interactive</span></div>
        <div id="db-status" style="font-size: 0.8rem; color: var(--success);">● Online</div>
    </header>

    <div class="search-container">
        <input type="text" id="targetId" placeholder="ID da Fórmula Alvo (ex: 424)" style="width: 250px;">
        <select id="topN">
            <option value="10">Analisar Top 10</option>
            <option value="20" selected>Analisar Top 20</option>
            <option value="50">Analisar Top 50</option>
        </select>
        <button onclick="iniciarAnalise()" class="btn-search">Buscar Similares</button>
    </div>

    <div class="grid-layout">
        <!-- Coluna Esquerda: Alvo -->
        <div>
            <div id="alvo-container">
                <div style="text-align: center; color: var(--text-dim); padding: 40px; border: 1px dashed var(--border); border-radius: 12px;">
                    Aguardando Busca...
                </div>
            </div>
        </div>

        <!-- Coluna Direita: Filtros e Resultados -->
        <div>
            <!-- Painel de Filtros Dinâmicos -->
            <div id="filters-panel" class="filters-panel" style="display:none;">
                <div class="filters-title">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                    <span>REFINE POR ADITIVOS (Clique para filtrar)</span>
                    <button onclick="limparFiltros()" style="margin-left:auto; background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:0.75rem; text-decoration:underline;">Limpar</button>
                </div>
                <div id="filters-container" class="filters-container"></div>
            </div>

            <!-- Lista -->
            <div id="results-list" class="results-list"></div>
        </div>
    </div>
</div>

<script>
    const CSV_URL = 'https://andregazineu.github.io/Formula-Matcher/database_limpo_final.csv';
    let DB = {};
    let RESULTADOS_ATUAIS = []; // Armazena os candidatos calculados
    let FILTROS_ATIVOS = new Set();

    // 1. Inicialização
    window.onload = () => {
        Papa.parse(CSV_URL, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, delimiter: ";",
            complete: (results) => {
                processarBanco(results.data);
                document.getElementById('loader').classList.add('fade-out');
            }
        });
    };

    function processarBanco(data) {
        data.forEach(row => {
            const id = String(row.ID_Composicao);
            const desc = String(row.Descricao_Material).toUpperCase();
            
            // Classificação
            let tipo = 'BASE';
            let nomeFiltro = null;

            if (desc.startsWith('PIG.')) tipo = 'PIGMENTO';
            else if (desc.startsWith('ADIT.')) {
                tipo = 'ADITIVO';
                // Remove prefixo para ficar bonito no botão (ex: "ADIT. UV" -> "UV")
                nomeFiltro = desc.replace(/^ADIT\.\s*/, '').split(' -')[0].trim(); 
            }

            if (!DB[id]) {
                DB[id] = { id, nome: row.Nome_Composicao, vetorBase: {}, vetorPig: {}, aditivosSet: new Set(), itens: [] };
            }

            const chave = `${row.Grupo_Rosca}_${row.Cod_Material}`;
            const qtd = row.Qtd_Corrigida_No_Filme || 0;

            if (tipo === 'BASE') DB[id].vetorBase[chave] = (DB[id].vetorBase[chave] || 0) + qtd;
            if (tipo === 'PIGMENTO') DB[id].vetorPig[chave] = (DB[id].vetorPig[chave] || 0) + qtd;
            if (tipo === 'ADITIVO' && nomeFiltro) DB[id].aditivosSet.add(nomeFiltro);

            DB[id].itens.push({
                desc: row.Descricao_Material,
                displayDesc: desc.replace(/^ADIT\.\s*/, '').replace(/^PIG\.\s*/, ''),
                tipo: tipo,
                rosca: row.Grupo_Rosca,
                percRosca: row.Percentual_Rosca,
                qtd: row.Qtd_Original_Na_Rosca || 0
            });
        });
    }

    // 2. Matemática
    function cosseno(vecA, vecB) {
        let dot = 0, mA = 0, mB = 0;
        const keys = new Set([...Object.keys(vecA), ...Object.keys(vecB)]);
        for (let k of keys) {
            const vA = vecA[k] || 0; const vB = vecB[k] || 0;
            dot += vA * vB; mA += vA * vA; mB += vB * vB;
        }
        if (mA === 0 && mB === 0) return 1.0;
        if (mA === 0 || mB === 0) return 0.0;
        return dot / (Math.sqrt(mA) * Math.sqrt(mB));
    }

    function temPigmento(comp) { return Object.keys(comp.vetorPig).length > 0; }

    // 3. Motor de Busca
    function iniciarAnalise() {
        const targetId = document.getElementById('targetId').value.trim();
        if (!DB[targetId]) return alert("ID não encontrado!");

        const alvo = DB[targetId];
        renderAlvo(alvo);
        
        // Resetar interface
        FILTROS_ATIVOS.clear();
        document.getElementById('filters-panel').style.display = 'block';

        const candidatos = [];
        const alvoTemCor = temPigmento(alvo);

        Object.keys(DB).forEach(id => {
            if (id === targetId) return;
            const cand = DB[id];

            // Filtro de Cor (Porteiro)
            const candTemCor = temPigmento(cand);
            if (alvoTemCor !== candTemCor) return;
            if (alvoTemCor && cosseno(alvo.vetorPig, cand.vetorPig) < 0.8) return;

            // Similaridade Estrutural (Resinas)
            const score = cosseno(alvo.vetorBase, cand.vetorBase);

            if (score > 0.5) { // Corte mínimo
                candidatos.push({ ...cand, score: score });
            }
        });

        // Ordenar por Resina
        candidatos.sort((a, b) => b.score - a.score);
        
        // Cortar Top N
        const topN = parseInt(document.getElementById('topN').value);
        RESULTADOS_ATUAIS = candidatos.slice(0, topN);

        gerarFiltrosDinamicos(alvo);
        atualizarListaVisual();
    }

    // 4. Lógica de Filtros (Árvore)
    function gerarFiltrosDinamicos(alvo) {
        const container = document.getElementById('filters-container');
        container.innerHTML = '';

        // Coletar TODOS os aditivos presentes nos Top Candidatos
        const todosAditivos = new Set();
        RESULTADOS_ATUAIS.forEach(cand => {
            cand.aditivosSet.forEach(ad => todosAditivos.add(ad));
        });

        // Criar botões
        Array.from(todosAditivos).sort().forEach(ad => {
            const btn = document.createElement('div');
            btn.className = 'filter-chip';
            btn.textContent = ad;
            
            // Se o alvo já tem esse aditivo, destaca visualmente (opcional)
            if (alvo.aditivosSet.has(ad)) {
                btn.classList.add('match'); 
                btn.title = "Presente na fórmula alvo";
            }

            btn.onclick = () => toggleFiltro(ad, btn);
            container.appendChild(btn);
        });
    }

    function toggleFiltro(ad, btnElement) {
        if (FILTROS_ATIVOS.has(ad)) {
            FILTROS_ATIVOS.delete(ad);
            btnElement.classList.remove('active');
        } else {
            FILTROS_ATIVOS.add(ad);
            btnElement.classList.add('active');
        }
        atualizarListaVisual();
    }

    function limparFiltros() {
        FILTROS_ATIVOS.clear();
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        atualizarListaVisual();
    }

    function atualizarListaVisual() {
        const container = document.getElementById('results-list');
        container.innerHTML = '';
        
        let visiveis = 0;

        RESULTADOS_ATUAIS.forEach(cand => {
            // Verifica se o candidato tem TODOS os filtros ativos
            let atendeFiltros = true;
            for (let filtro of FILTROS_ATIVOS) {
                if (!cand.aditivosSet.has(filtro)) {
                    atendeFiltros = false;
                    break;
                }
            }

            if (atendeFiltros) {
                visiveis++;
                container.appendChild(criarCardResultado(cand));
            }
        });

        if (visiveis === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Nenhuma fórmula atende a combinação de aditivos selecionada.</div>';
        }
    }

    // 5. Renderização
    function criarCardResultado(dados) {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div class="card-top">
                <div>
                    <div style="color:white; font-weight:700;">${dados.nome}</div>
                    <div style="font-size:0.8rem; color:var(--text-dim);">ID: ${dados.id}</div>
                </div>
                <div class="similarity-badge">
                    <div class="score-val">${(dados.score * 100).toFixed(0)}%</div>
                    <div class="score-label">Resina</div>
                </div>
            </div>
            
            <details>
                <summary style="cursor:pointer; color:var(--primary); font-size:0.8rem;">Ver Composição</summary>
                <div class="structure-preview">
                    ${gerarLinhasItens(dados.itens)}
                </div>
            </details>
        `;
        return div;
    }

    function renderAlvo(dados) {
        document.getElementById('alvo-container').innerHTML = `
            <div class="target-card">
                <div class="target-header">
                    <div style="font-size:0.7rem; color:var(--primary); font-weight:bold;">REFERÊNCIA</div>
                    <h3 style="color:white; margin:5px 0;">${dados.nome}</h3>
                    <div style="color:var(--text-dim); font-size:0.9rem;">ID: ${dados.id}</div>
                </div>
                <div class="structure-preview">
                    ${gerarLinhasItens(dados.itens)}
                </div>
            </div>
        `;
    }

    function gerarLinhasItens(itens) {
        // Agrupar por rosca
        const grupos = itens.reduce((acc, item) => {
            if (!acc[item.rosca]) acc[item.rosca] = { perc: item.percRosca, html: [] };
            
            const classe = item.tipo === 'BASE' ? 'tag-res' : (item.tipo === 'PIGMENTO' ? 'tag-fun' : 'tag-fun'); // Pigmento usa cor func visualmente aqui
            const html = `
                <div class="layer-row">
                    <span class="mat-tag ${classe}">${item.tipo.substring(0,3)}</span>
                    <span style="color:#ddd; flex:1;">${item.displayDesc}</span>
                    <strong style="color:var(--text);">${item.qtd.toFixed(1)}%</strong>
                </div>
            `;
            acc[item.rosca].html.push(html);
            return acc;
        }, {});

        return Object.keys(grupos).sort().map(r => `
            <div style="margin-top:10px;">
                <div style="font-size:0.75rem; color:#666; font-weight:bold; border-bottom:1px solid #333; margin-bottom:5px;">
                    ${r} (${grupos[r].perc}%)
                </div>
                ${grupos[r].html.join('')}
            </div>
        `).join('');
    }
</script>

</body>
</html>
